<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> mongoose 学习 · 金缮的随笔</title><meta name="description" content="mongoose 学习 - 晓松"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="yexiaosong.github.io/atom.xml" title="金缮的随笔"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="金缮的随笔" type="application/atom+xml">
</head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">金缮的随笔</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>主页</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>归档</p></a><a href="/about" target="_self" class="li component-nav-item"><p>关于</p></a><ul class="shortcut-icons"><a href="https://github.com/yexiaosong" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="https://www.zhihu.com/people/yexiaosong" target="_blank"><img src="/images/zhihu.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">mongoose 学习</h1><div class="post-info">2017年1月11日</div><div class="post-content"><h3 id="mongoose基本使用"><a href="#mongoose基本使用" class="headerlink" title="mongoose基本使用"></a>mongoose基本使用</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose=<span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line"><span class="comment">//1.创建连接</span></span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/myBlog'</span>)</span><br><span class="line"><span class="comment">//2.创建UserSchema方法</span></span><br><span class="line"><span class="keyword">var</span> UserSchema=mongoose.Schema(&#123;</span><br><span class="line">    nickname:&#123;</span><br><span class="line">        type:<span class="built_in">String</span>,</span><br><span class="line">        <span class="keyword">default</span>:<span class="string">'hah'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    creatTime:&#123;</span><br><span class="line">        type:<span class="built_in">Date</span>,</span><br><span class="line">        <span class="keyword">default</span>:<span class="built_in">Date</span>.now()</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//3.创建User数据模型</span></span><br><span class="line"><span class="keyword">var</span> User=mongoose.model(<span class="string">'User'</span>,UserSchema)</span><br><span class="line"><span class="comment">//4.创建实例user</span></span><br><span class="line"><span class="keyword">var</span> user=<span class="keyword">new</span> User()</span><br><span class="line"><span class="built_in">console</span>.log(user);</span><br></pre></td></tr></table></figure>
<h3 id="mongoose的set和get修饰符"><a href="#mongoose的set和get修饰符" class="headerlink" title="mongoose的set和get修饰符"></a>mongoose的set和get修饰符</h3><ul>
<li>get <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose=<span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/myBlog'</span>)</span><br><span class="line"><span class="keyword">var</span> UserSchema=mongoose.Schema(&#123;</span><br><span class="line">    blog:&#123;</span><br><span class="line">        type:<span class="built_in">String</span>,</span><br><span class="line">        <span class="keyword">get</span>: function(url)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!url) <span class="keyword">return</span> url;</span><br><span class="line">            <span class="keyword">if</span>(<span class="number">0</span>!==url.indexOf(<span class="string">"http://"</span>)&amp;&amp; <span class="number">0</span>!==url.indexOf(<span class="string">"https://"</span>))</span><br><span class="line">                url=<span class="string">'http://'</span>+url;</span><br><span class="line">                <span class="keyword">return</span> url;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> User= mongoose.model(<span class="string">'User'</span>,UserSchema);</span><br><span class="line"><span class="keyword">var</span> user=<span class="keyword">new</span> User(&#123;</span><br><span class="line">    blog:<span class="string">'www.heheda.com'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;<span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">'save err'</span>);&#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'user blog is  '</span>+user.blog);</span><br><span class="line"></span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//结果是把网址的协议补充完整，get在数据初始化后、保存文件之前进行的</span></span><br></pre></td></tr></table></figure></li>
<li>set与get用法相同，只是处理的时间不同。<h3 id="mongoose的虚拟属性Schema-virtual"><a href="#mongoose的虚拟属性Schema-virtual" class="headerlink" title="mongoose的虚拟属性Schema.virtual()"></a>mongoose的虚拟属性Schema.virtual()</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose=<span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line"><span class="keyword">var</span> PersonSchema=<span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    firstName:<span class="built_in">String</span>,</span><br><span class="line">    lastName:<span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line">PersonSchema.virtual(<span class="string">'fullname'</span>).get(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.firstName+<span class="string">'-'</span>+<span class="keyword">this</span>.lastName;</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">var</span> Person=mongoose.model(<span class="string">'Person'</span>,PersonSchema);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> person=<span class="keyword">new</span> Person(&#123;</span><br><span class="line">    firstName:<span class="string">'Alex'</span>,</span><br><span class="line">    lastName:<span class="string">'Ye'</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'user fullname'</span>,person.fullname);</span><br></pre></td></tr></table></figure>
但是在模型实例转化为JSON属性时，会显示firstName及lastName,没有fullname.<br>,为了让其显示虚拟属性，需要在PersonSchema.virtual…代码块后面加一句<br>PersonSchema.set(‘toJSON’,{getter:true,virtual:true});<h3 id="mongoose的索引"><a href="#mongoose的索引" class="headerlink" title="mongoose的索引"></a>mongoose的索引</h3></li>
</ul>
<h3 id="mongoose模型的方法"><a href="#mongoose模型的方法" class="headerlink" title="mongoose模型的方法"></a>mongoose模型的方法</h3><ul>
<li>添加静态方法(调用静态方法，使用模型调用即可)<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose=<span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/myBlog'</span>)</span><br><span class="line"><span class="keyword">var</span> UserSchema=mongoose.Schema(&#123;</span><br><span class="line">    name:<span class="built_in">String</span>,</span><br><span class="line">    id:<span class="built_in">Number</span></span><br><span class="line">&#125;)</span><br><span class="line">UserSchema.statics.findById=<span class="function"><span class="keyword">function</span>(<span class="params">id,cb</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.findOne(&#123;<span class="attr">id</span>:id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">        cb(err,doc)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> User= mongoose.model(<span class="string">'User'</span>,UserSchema);</span><br><span class="line"><span class="keyword">var</span> user=<span class="keyword">new</span> User(&#123;</span><br><span class="line">    name:<span class="string">"yezong"</span>,</span><br><span class="line">    id:<span class="number">10086</span></span><br><span class="line">&#125;);</span><br><span class="line">user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">'save user failed'</span>,err);</span><br><span class="line">    &#125;</span><br><span class="line">    User.findById(<span class="number">10086</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'findById,err,doc:'</span>,err,doc);</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></li>
<li>实例方法<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> mongoose=<span class="built_in">require</span>(<span class="string">'mongoose'</span>)</span><br><span class="line">mongoose.connect(<span class="string">'mongodb://localhost/myBlog'</span>)</span><br><span class="line"><span class="keyword">var</span> UserSchema=mongoose.Schema(&#123;</span><br><span class="line">    name:<span class="built_in">String</span>,</span><br><span class="line">    id:<span class="built_in">Number</span></span><br><span class="line">&#125;)</span><br><span class="line">UserSchema.statics.findById=<span class="function"><span class="keyword">function</span>(<span class="params">id,cb</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.findOne(&#123;<span class="attr">id</span>:id&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">        cb(err,doc)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line">UserSchema.methods.print=<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'the name of the user:'</span>+<span class="keyword">this</span>.name)</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'the id of the user:'</span>+<span class="keyword">this</span>.id)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> User= mongoose.model(<span class="string">'User'</span>,UserSchema);</span><br><span class="line"><span class="keyword">var</span> user=<span class="keyword">new</span> User(&#123;</span><br><span class="line">    name:<span class="string">"yezong"</span>,</span><br><span class="line">    id:<span class="number">10086</span></span><br><span class="line">&#125;);</span><br><span class="line">user.save(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">console</span>.log(<span class="string">'save user failed'</span>,err);</span><br><span class="line">    &#125;</span><br><span class="line">    User.findById(<span class="number">10086</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'findById,err,doc:'</span>,err,doc);</span><br><span class="line">    &#125;)</span><br><span class="line">    user.print();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="数据校验（在mongoose-Schema对象内声明）"><a href="#数据校验（在mongoose-Schema对象内声明）" class="headerlink" title="数据校验（在mongoose.Schema对象内声明）"></a>数据校验（在mongoose.Schema对象内声明）</h3></li>
<li>required如果分号后为true的话没有数据会报错</li>
<li>max min<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3></li>
<li>post保存好进行操作<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> UserSchema=<span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    address: <span class="built_in">String</span></span><br><span class="line">&#125;)</span><br><span class="line">UserSchema.post(<span class="string">'save'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">next</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'sucess'</span>);</span><br><span class="line">    next()</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">//操作过程，先保存，在进行console操作，最后next</span></span><br></pre></td></tr></table></figure></li>
<li>pre保存前操作<h3 id="ref读取别的数据库（官方文档的Population）"><a href="#ref读取别的数据库（官方文档的Population）" class="headerlink" title="ref读取别的数据库（官方文档的Population）"></a>ref读取别的数据库（官方文档的Population）</h3></li>
<li>DBref</li>
<li>populate()<h3 id="运算符"><a href="#运算符" class="headerlink" title="$运算符"></a>$运算符</h3></li>
<li>或查询<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cond=&#123;</span><br><span class="line">    $or:[</span><br><span class="line">    &#123;<span class="attr">name</span>:<span class="string">"Alex"</span>&#125;</span><br><span class="line">    &#123;<span class="attr">name</span>:<span class="string">"Aston"</span>&#125;</span><br><span class="line">]&#125; </span><br><span class="line">user.find(cond,<span class="function"><span class="keyword">function</span>(<span class="params">err,doc</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(err)</span><br><span class="line">    <span class="comment">//...省略</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
</div></article></div></div></main><footer class="footer-container"><div class="paginator"><a href="/2017/01/14/jade%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="prev">上一篇</a><a href="/2017/01/09/redis%E5%AD%A6%E4%B9%A0%E6%96%87%E6%A1%A3/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2020 <a href="yexiaosong.github.io">晓松</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer></body></html>